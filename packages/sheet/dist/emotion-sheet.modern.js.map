{"version":3,"file":"emotion-sheet.modern.js","sources":["../src/index.js"],"sourcesContent":["// @flow\n/*\n\nBased off glamor's StyleSheet, thanks Sunil ❤️\n\nhigh performance StyleSheet for css-in-js systems\n\n- uses multiple style tags behind the scenes for millions of rules\n- uses `insertRule` for appending in production for *much* faster performance\n\n// usage\n\nimport { StyleSheet } from '@emotion/sheet'\n\nlet styleSheet = new StyleSheet({ key: '', container: document.head })\n\nstyleSheet.insert('#box { border: 1px solid red; }')\n- appends a css rule into the stylesheet\n\nstyleSheet.flush()\n- empties the stylesheet of all its contents\n\n*/\n\n// $FlowFixMe\nfunction sheetForTag(tag: HTMLStyleElement): CSSStyleSheet {\n  if (tag.sheet) {\n    // $FlowFixMe\n    return tag.sheet\n  }\n\n  // this weirdness brought to you by firefox\n  /* istanbul ignore next */\n  for (let i = 0; i < document.styleSheets.length; i++) {\n    if (document.styleSheets[i].ownerNode === tag) {\n      // $FlowFixMe\n      return document.styleSheets[i]\n    }\n  }\n}\n\nexport type Options = {\n  nonce?: string,\n  key: string,\n  container: HTMLElement,\n  speedy?: boolean,\n  prepend?: boolean,\n}\n\nfunction createStyleElement(options: {\n  key: string,\n  nonce: string | void,\n}): HTMLStyleElement {\n  let tag = document.createElement('style')\n  tag.setAttribute('data-emotion', options.key)\n  if (options.nonce !== undefined) {\n    tag.setAttribute('nonce', options.nonce)\n  }\n  tag.appendChild(document.createTextNode(''))\n  tag.setAttribute('data-s', '')\n  return tag\n}\n\nexport class StyleSheet {\n  isSpeedy: boolean\n  ctr: number\n  tags: HTMLStyleElement[]\n  container: HTMLElement\n  key: string\n  nonce: string | void\n  prepend: boolean | void\n  before: Element | null\n  constructor(options: Options) {\n    this.isSpeedy =\n      options.speedy === undefined\n        ? process.env.NODE_ENV === 'production'\n        : options.speedy\n    this.tags = []\n    this.ctr = 0\n    this.nonce = options.nonce\n    // key is the value of the data-emotion attribute, it's used to identify different sheets\n    this.key = options.key\n    this.container = options.container\n    this.prepend = options.prepend\n    this.before = null\n  }\n\n  _insertTag = (tag: HTMLStyleElement) => {\n    let before\n    if (this.tags.length === 0) {\n      before = this.prepend ? this.container.firstChild : this.before\n    } else {\n      before = this.tags[this.tags.length - 1].nextSibling\n    }\n    this.container.insertBefore(tag, before)\n    this.tags.push(tag)\n  }\n\n  hydrate(nodes: HTMLStyleElement[]) {\n    nodes.forEach(this._insertTag)\n  }\n\n  insert(rule: string) {\n    // the max length is how many rules we have per style tag, it's 65000 in speedy mode\n    // it's 1 in dev because we insert source maps that map a single rule to a location\n    // and you can only have one source map per style tag\n    if (this.ctr % (this.isSpeedy ? 65000 : 1) === 0) {\n      this._insertTag(createStyleElement(this))\n    }\n    const tag = this.tags[this.tags.length - 1]\n\n    if (process.env.NODE_ENV !== 'production') {\n      const isImportRule =\n        rule.charCodeAt(0) === 64 && rule.charCodeAt(1) === 105\n\n      if (isImportRule && (this: any)._alreadyInsertedOrderInsensitiveRule) {\n        // this would only cause problem in speedy mode\n        // but we don't want enabling speedy to affect the observable behavior\n        // so we report this error at all times\n        console.error(\n          `You're attempting to insert the following rule:\\n` +\n            rule +\n            '\\n\\n`@import` rules must be before all other types of rules in a stylesheet but other rules have already been inserted. Please ensure that `@import` rules are before all other rules.'\n        )\n      }\n\n      ;(this: any)._alreadyInsertedOrderInsensitiveRule =\n        (this: any)._alreadyInsertedOrderInsensitiveRule || !isImportRule\n    }\n\n    if (this.isSpeedy) {\n      const sheet = sheetForTag(tag)\n      try {\n        // this is the ultrafast version, works across browsers\n        // the big drawback is that the css won't be editable in devtools\n        sheet.insertRule(rule, sheet.cssRules.length)\n      } catch (e) {\n        if (\n          process.env.NODE_ENV !== 'production' &&\n          !/:(-moz-placeholder|-ms-input-placeholder|-moz-read-write|-moz-read-only){/.test(\n            rule\n          )\n        ) {\n          console.error(\n            `There was a problem inserting the following rule: \"${rule}\"`,\n            e\n          )\n        }\n      }\n    } else {\n      tag.appendChild(document.createTextNode(rule))\n    }\n    this.ctr++\n  }\n\n  flush() {\n    // $FlowFixMe\n    this.tags.forEach((tag) => tag.parentNode.removeChild(tag))\n    this.tags = []\n    this.ctr = 0\n    if (process.env.NODE_ENV !== 'production') {\n      ;(this: any)._alreadyInsertedOrderInsensitiveRule = false\n    }\n  }\n}\n"],"names":["StyleSheet","constructor","options","_insertTag","tag","before","this","tags","length","prepend","container","firstChild","nextSibling","insertBefore","push","isSpeedy","undefined","speedy","process","env","NODE_ENV","ctr","nonce","key","hydrate","nodes","forEach","insert","rule","document","createElement","setAttribute","appendChild","createTextNode","createStyleElement","isImportRule","charCodeAt","_alreadyInsertedOrderInsensitiveRule","console","error","sheet","i","styleSheets","ownerNode","sheetForTag","insertRule","cssRules","e","test","flush","parentNode","removeChild"],"mappings":"MA+DaA,EASXC,YAAYC,QAeZC,WAAcC,IACZ,IAAIC,EAEFA,EADuB,IAArBC,KAAKC,KAAKC,OACHF,KAAKG,QAAUH,KAAKI,UAAUC,WAAaL,KAAKD,OAEhDC,KAAKC,KAAKD,KAAKC,KAAKC,OAAS,GAAGI,YAE3CN,KAAKI,UAAUG,aAAaT,EAAKC,GACjCC,KAAKC,KAAKO,KAAKV,IAtBfE,KAAKS,cACgBC,IAAnBd,EAAQe,OACqB,eAAzBC,QAAQC,IAAIC,SACZlB,EAAQe,OACdX,KAAKC,KAAO,GACZD,KAAKe,IAAM,EACXf,KAAKgB,MAAQpB,EAAQoB,MAErBhB,KAAKiB,IAAMrB,EAAQqB,IACnBjB,KAAKI,UAAYR,EAAQQ,UACzBJ,KAAKG,QAAUP,EAAQO,QACvBH,KAAKD,OAAS,KAchBmB,QAAQC,GACNA,EAAMC,QAAQpB,KAAKH,YAGrBwB,OAAOC,GAIDtB,KAAKe,KAAOf,KAAKS,SAAW,KAAQ,IAAO,GAC7CT,KAAKH,WA1DX,SAA4BD,GAI1B,IAAIE,EAAMyB,SAASC,cAAc,SAOjC,OANA1B,EAAI2B,aAAa,eAAgB7B,EAAQqB,UACnBP,IAAlBd,EAAQoB,OACVlB,EAAI2B,aAAa,QAAS7B,EAAQoB,OAEpClB,EAAI4B,YAAYH,SAASI,eAAe,KACxC7B,EAAI2B,aAAa,SAAU,IACpB3B,EA+Ca8B,CAAmB5B,OAErC,MAAMF,EAAME,KAAKC,KAAKD,KAAKC,KAAKC,OAAS,GAEzC,GAA6B,eAAzBU,QAAQC,IAAIC,SAA2B,CACzC,MAAMe,EACmB,KAAvBP,EAAKQ,WAAW,IAAoC,MAAvBR,EAAKQ,WAAW,GAE3CD,GAAiB7B,KAAW+B,sCAI9BC,QAAQC,MACL,oDACCX,EACA,0LAIJtB,KAAW+B,qCACV/B,KAAW+B,uCAAyCF,EAGzD,GAAI7B,KAAKS,SAAU,CACjB,MAAMyB,EA1GZ,SAAqBpC,GACnB,GAAIA,EAAIoC,MAEN,OAAOpC,EAAIoC,MAKb,IAAK,IAAIC,EAAI,EAAGA,EAAIZ,SAASa,YAAYlC,OAAQiC,IAC/C,GAAIZ,SAASa,YAAYD,GAAGE,YAAcvC,EAExC,OAAOyB,SAASa,YAAYD,GA+FdG,CAAYxC,GAC1B,IAGEoC,EAAMK,WAAWjB,EAAMY,EAAMM,SAAStC,QACtC,MAAOuC,GAEoB,eAAzB7B,QAAQC,IAAIC,UACX,4EAA4E4B,KAC3EpB,IAGFU,QAAQC,MACL,sDAAqDX,KACtDmB,SAKN3C,EAAI4B,YAAYH,SAASI,eAAeL,IAE1CtB,KAAKe,MAGP4B,QAEE3C,KAAKC,KAAKmB,QAAStB,GAAQA,EAAI8C,WAAWC,YAAY/C,IACtDE,KAAKC,KAAO,GACZD,KAAKe,IAAM,EACkB,eAAzBH,QAAQC,IAAIC,WACZd,KAAW+B,sCAAuC"}